generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// ENUMS
// ==========================================
enum Role {
  SUPER_ADMIN
  OWNER
  CASHIER
}

enum PaymentMethod {
  CASH
  YAPE
  PLIN
  CARD
  TRANSFER
}

enum InvoiceType {
  BOLETA
  FACTURA
  NOTA_VENTA
}

enum InvoiceStatus {
  PENDING
  SENT
  ACCEPTED
  REJECTED
  VOIDED
}

enum NotificationType {
  CASH_OPENED
  CASH_CLOSED
  DAILY_SUMMARY
  ALERT
}

enum AuditAction {
  LOGIN
  LOGOUT
  CREATE_SALE
  OPEN_CASH
  CLOSE_CASH
  UPDATE_STOCK
  CREATE_USER
  DELETE_USER
  SYSTEM_ERROR
}

// ==========================================
// NEGOCIOS
// ==========================================
model Business {
  id          String     @id @default(uuid())
  name        String
  ruc         String     @unique
  address     String?
  logoUrl     String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relaciones
  branches    Branch[]
  users       User[]
  products    Product[]
  categories  Category[]
  customers   Customer[]
  sales       Sale[]     // üëà Esto requiere la relaci√≥n inversa en Sale
  sunatConfig SunatConfig?
  auditLogs   AuditLog[]
}

// ==========================================
// SUCURSALES
// ==========================================
model Branch {
  id          String      @id @default(uuid())
  businessId  String
  name        String
  address     String?
  phone       String?

  business    Business    @relation(fields: [businessId], references: [id])
  stock       Stock[]
  users       User[]
  cashSessions CashSession[]
  sales       Sale[]

  @@index([businessId])
}

// ==========================================
// USUARIOS
// ==========================================
model User {
  id          String    @id @default(uuid())
  businessId  String?
  branchId    String?
  name        String
  email       String    @unique
  password    String
  role        Role      @default(CASHIER)
  pin         String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  business    Business? @relation(fields: [businessId], references: [id])
  branch      Branch?   @relation(fields: [branchId], references: [id])
  sessions    CashSession[]
  sales       Sale[]
  auditLogs   AuditLog[]

  @@index([businessId])
  @@index([branchId])
}

// ==========================================
// CATEGORIAS Y PRODUCTOS
// ==========================================
model Category {
  id          String    @id @default(uuid())
  businessId  String
  name        String
  business    Business  @relation(fields: [businessId], references: [id])
  products    Product[]

  @@index([businessId])
}

model Product {
  id          String     @id @default(uuid())
  businessId  String
  categoryId  String?
  name        String
  code        String?    // Barcode o SKU
  description String?
  price       Decimal    @db.Decimal(12,2)
  cost        Decimal?   @db.Decimal(12,2)
  imageUrl    String?
  minStock    Int        @default(5)
  active      Boolean    @default(true)

  business    Business   @relation(fields: [businessId], references: [id])
  category    Category?  @relation(fields: [categoryId], references: [id])
  stock       Stock[]
  saleItems   SaleItem[]

  @@unique([businessId, code])
  @@index([businessId])
}

// ==========================================
// INVENTARIO
// ==========================================
model Stock {
  id          String    @id @default(uuid())
  branchId    String
  productId   String
  quantity    Int       @default(0)
  updatedAt   DateTime  @updatedAt

  branch      Branch    @relation(fields: [branchId], references: [id])
  product     Product   @relation(fields: [productId], references: [id])

  @@unique([branchId, productId])
  @@index([branchId])
}

// ==========================================
// CAJA Y FLUJO DE DINERO
// ==========================================
model CashSession {
  id          String    @id @default(uuid())
  branchId    String
  userId      String
  openedAt    DateTime  @default(now())
  closedAt    DateTime?
  initialCash Decimal    @db.Decimal(12,2)
  finalCash   Decimal?   @db.Decimal(12,2)
  income      Decimal    @default(0) @db.Decimal(12,2)
  expense     Decimal    @default(0) @db.Decimal(12,2)
  difference  Decimal?   @db.Decimal(12,2)
  status      String     @default("OPEN")

  branch      Branch    @relation(fields: [branchId], references: [id])
  user        User      @relation(fields: [userId], references: [id])
  sales       Sale[]
}

// ==========================================
// CLIENTES
// ==========================================
model Customer {
  id          String    @id @default(uuid())
  businessId  String
  name        String
  docType     String?
  docNumber   String?
  email       String?
  phone       String?

  business    Business  @relation(fields: [businessId], references: [id])
  sales       Sale[]

  @@unique([businessId, docNumber])
}

// ==========================================
// VENTAS
// ==========================================
model Sale {
  id            String        @id @default(uuid())
  code          String        @default(cuid())
  externalId    String?       @unique
  businessId    String?
  branchId      String
  cashSessionId String?
  userId        String
  customerId    String?

  subtotal      Decimal       @db.Decimal(12,2)
  discount      Decimal       @default(0) @db.Decimal(12,2)
  total         Decimal       @db.Decimal(12,2)
  status        String        @default("COMPLETED")
  createdAt     DateTime      @default(now())

  // RELACIONES
  // üëá AQU√ç ESTABA EL ERROR: Faltaba la relaci√≥n con Business
  business      Business?     @relation(fields: [businessId], references: [id]) 
  
  branch        Branch        @relation(fields: [branchId], references: [id])
  user          User          @relation(fields: [userId], references: [id])
  customer      Customer?     @relation(fields: [customerId], references: [id])
  cashSession   CashSession?  @relation(fields: [cashSessionId], references: [id])
  items         SaleItem[]
  payments      SalePayment[]
  invoice       Invoice?
}

model SaleItem {
  id          String    @id @default(uuid())
  saleId      String
  productId   String
  quantity    Int
  price       Decimal   @db.Decimal(12,2)
  subtotal    Decimal   @db.Decimal(12,2)

  sale        Sale      @relation(fields: [saleId], references: [id])
  product     Product   @relation(fields: [productId], references: [id])

  @@index([saleId])
}

model SalePayment {
  id          String        @id @default(uuid())
  saleId      String
  method      PaymentMethod
  amount      Decimal       @db.Decimal(12,2)
  reference   String?

  sale        Sale          @relation(fields: [saleId], references: [id])
}

// ==========================================
// FACTURACI√ìN SUNAT
// ==========================================
model Invoice {
  id          String        @id @default(uuid())
  saleId      String        @unique
  invoiceType InvoiceType
  serie       String
  number      Int
  status      InvoiceStatus @default(PENDING)
  pdfUrl      String?
  xmlUrl      String?
  cdrUrl      String?
  issuedAt    DateTime      @default(now())

  sale        Sale          @relation(fields: [saleId], references: [id])
}

model SunatConfig {
  id            String   @id @default(uuid())
  businessId    String   @unique
  solUser       String?
  solPassword   String?
  certPassword  String?
  active        Boolean  @default(false)

  business      Business @relation(fields: [businessId], references: [id])
}

// ==========================================
// NOTIFICACIONES
// ==========================================
model Notification {
  id          String          @id @default(uuid())
  userId      String?
  title       String
  message     String
  type        NotificationType
  read        Boolean         @default(false)
  createdAt   DateTime        @default(now())
}

// ==========================================
// AUDITOR√çA
// ==========================================
model AuditLog {
  id          String      @id @default(uuid())
  businessId  String
  userId      String?
  action      AuditAction
  details     String?
  ipAddress   String?
  createdAt   DateTime    @default(now())

  business    Business    @relation(fields: [businessId], references: [id])
  user        User?       @relation(fields: [userId], references: [id])
}